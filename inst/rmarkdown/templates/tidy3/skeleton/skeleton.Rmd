---
title: "VMS cleanup and summary - interactive"
params:
  country:
    choices:
    - Iceland
    - Ghana
    - Liberia
    - Sierra Leone
    input: select
    label: 'Country:'
    value: Iceland
  input:
    input: file
    label: 'Input file name:'
    value: iceland_vms.csv
  output:
    input: text
    label: 'Output file name:'
    value: vms_standardized.csv
  speed.min:
    input: numeric
    label: 'Minimum fishing speed:'
    value: 2
  speed.max:
    input: numeric
    label: 'Maximum fishing speed:'
    value: 4.5
  speed.limit:
    input: numeric
    label: 'Maximum plausable speed:'
    value: 15
output:
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```


## Preamble

The code in this Rmarkdown document imports some vms data

produces a clean VMS dataset with the same column names so it can be used with the other Rmarkdown documents.  The output format includes the following five columns:

* vid - vessel ID
* date - Date (in format YYYY-MM-DD HH:MM.SS)
* lat - Latitude (in decimal degrees)
* lon - Longitude (in decimal degrees)
* speed - Instantaneous reported vessel speed (in knots)
* country - Name of country - used in later processing

## Input parameters (user specification)

**"Reactive parameters"**:
```{r}
params
country <- params$country
file.in <- params$input
file.out <- params$output
speed.min = params$speed.min
speed.max = params$speed.max
speed.limit = params$speed.limit
```

**"Fixed parameters (may be included in reactive parameters at a later stage)"**:
```{r, echo = TRUE}
# DATE RANGE TO INCLUDE IN THE ANALYSIS ----------------------------------------
#      Dates outside this range will be removed before the output files is saved
#      Lets call this our standardized format

# Filter VMS data by a date interval?
# Choices are "Yes" or "No"
filter.by.date = "No"   # choices "Yes" or "No"
# If yes above,  specify interval (use YYYY-MM-DD HH:MM:SS format)
date.min = "2000-01-01 00:00:00"
date.max = "2100-12-31 23:59:59"

```




```{r}
# Needed libaries
library(knitr)
library(tidyverse)
library(lubridate)
library(rio)
library(ghsllr)
```

```{r}
# Imports data -----------------------------------------------------------------
vms <- vms_import_data(file.in, country, lon.min, lon.max, lat.min, lat.max)
```


```{r}
if(filter.by.date == "Yes"){
  vms <- 
    vms %>%
    dplyr::filter(between(date, ymd_hms(date.min), ymd_hms(date.max)))
}

```

## Data summary

```{r}
vms %>%
  mutate(day = day(date)) %>%
  summarise(Date.minimum = min(date, na.rm = TRUE),
            Date.maximum = max(date, na.rm = TRUE),
            Date.range = lubridate::as_date(Date.maximum) - lubridate::as_date(Date.minimum) + 1,
            Date.distinct = n_distinct(day),
            Date.missing = sum(is.na(date)),
            Longitude.minimum = min(lon, na.rm = TRUE),
            Longitude.maximum = max(lon, na.rm = TRUE),
            Longitude.missing = sum(is.na(lon)),
            Latitude.minimum = min(lat, na.rm = TRUE),
            Latitude.maximum = max(lat, na.rm = TRUE),
            Latitude.missing = sum(is.na(lat)),
            Speed.minimum = min(speed, na.rm = TRUE),
            Speed.maximum = max(speed, na.rm = TRUE),
            Speed.missing = sum(is.na(speed)),
            Vessel.distinct = n_distinct(vid)) %>% 
  mutate_all(as.character) %>%
  gather(variable, value) %>%
  separate(variable, c("variable", "statistics")) %>%
  knitr::kable()

vms_plot_speed(vms)
```

## Vessel summary

```{r}

fs <- unique(vms$activity)
vms %>%
  group_by(vid) %>%
  summarise(Total_records = length(activity),
            Fishing_records = sum(activity == fs[1])) %>%
  rename(Vessel = vid) %>%
  knitr::kable()

vms %>%
  dplyr::select(vid, date, lon, lat, speed, fishing) %>%
  mutate(date = as.character(date)) %>%
  write_csv(file.out)

```
